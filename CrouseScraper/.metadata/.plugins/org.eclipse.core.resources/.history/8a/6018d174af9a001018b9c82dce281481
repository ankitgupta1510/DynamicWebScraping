package flow;

import org.jsoup.Connection;
import org.jsoup.Connection.Response;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.json.JSONArray;
import org.json.JSONObject;

public class MainTestCheck {

    public static void main(String[] args) {
        String carUrl = "https://www.policybazaar.com/services/getcarservices.php";
        String carPayload = "[{\"task\":\"topplans\",\"ismobile\":false,\"topPlanNew\":1,\"comprehensive\":1,\"plantypeid\":1}]";

        try {
            // Step 1: Network request karna aur response get karna
            Response response = Jsoup.connect(carUrl)
                    .userAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64)")
                    .header("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8")
                    .header("Accept-Language", "en-US,en;q=0.5")
                    .header("Content-Type", "application/x-www-form-urlencoded")
                    .ignoreContentType(true)
                    .timeout(15000)
                    .requestBody(carPayload)
                    .method(Connection.Method.POST)
                    .execute();

            
            String jsonResponse = response.body();
            JSONObject jsonObject = new JSONObject(jsonResponse);

            // Step 2: 'carTopPlansHtml' ki jagah 'planTypeWiseHtml' object ko nikalna
            JSONObject planTypeWiseObject = jsonObject.getJSONObject("planTypeWiseHtml");

            // Step 3: Jin categories ka data nikalna hai, unki keys define karna
            // Ye keys humne JSON response ko dekh kar nikali hain
            String[] categoryKeys = {"showCard1", "showCard4", "showCard2", "showCard5"};

            // Step 4: Har category key ke upar loop chalana
            for (String key : categoryKeys) {
                
                // Safety check: Agar koi key JSON me मौजूद nahi hai to error se bachne ke liye skip kar do
                if (!planTypeWiseObject.has(key)) {
                    continue;
                }

                // Step 5: Key se uss category ke saare plans ka JSON Array nikalna
                JSONArray plansArray = planTypeWiseObject.getJSONArray(key);

                // Ek accha sa heading print karne ke liye, pehle plan se category ka naam nikal lete hain
                if (plansArray.length() > 0) {
                    String firstPlanHtml = plansArray.getString(0);
                    Document tempDoc = Jsoup.parse(firstPlanHtml);
                    String categoryName = tempDoc.selectFirst(".planType .headingV3").text();
                    System.out.println("\n--- Plans for Category: " + categoryName + " ---");
                }
                
                // Step 6: Uss category ke har ek plan (HTML string) par loop chalana
                for (int i = 0; i < plansArray.length(); i++) {
                    // Array se ek plan ka HTML string nikalo
                    String singlePlanHtml = plansArray.getString(i);
                    // Uss string ko Jsoup Document me parse karo
                    Document planDoc = Jsoup.parse(singlePlanHtml);
                    
                    // Step 7: Data extract karna (aapka pehle wala logic hi hai)
                    String planType = planDoc.selectFirst(".planType .headingV3").text();
                    String planPremium = planDoc.selectFirst(".planBtn .primaryBtnV2").text();
                    String planLogo = planDoc.selectFirst(".column.logo img").attr("src");

                    System.out.println("PlanType - " + planType + " | Premium - " + planPremium + " | Logo - " + planLogo);
                }
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}