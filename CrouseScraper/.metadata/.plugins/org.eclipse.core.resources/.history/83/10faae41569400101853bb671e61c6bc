package CollegeScraper;
import org.apache.poi.ss.usermodel.Sheet;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import java.io.IOException;
import java.util.Map;

public class MainTestApp {
    public static void main(String[] args) throws IOException {
    	
    	ExcelExporter excelExporter = new ExcelExporter();
    	Map<String ,String> urlMap = BrowseByStream.streamScraper();
    	
    	for(Map.Entry<String,String> entry : urlMap.entrySet()) {
    		String streamName = entry.getKey();
            String urlString = entry.getValue();
    		
            System.out.println("Processing: " + streamName);
            
            Sheet sheet = excelExporter.createSheet(streamName);
            int rowNum = 1; // Start after header
            
        boolean hasData = true;
        int pageNum = 1;
        
        while(hasData) {
        	String url = "";
        	
        	if(urlString.equals("https://finance.careers360.com")) {
        		url = urlString + "/colleges/list-of-commerce-colleges-in-india" + "?page=" + pageNum;
        	}
        	else if(urlString.equals("https://hospitality.careers360.com")) {
        		url = urlString + "/colleges/list-of-hospitality-tourism-colleges-in-india" + "?page=" + pageNum;
        	}
        	else if(urlString.equals("https://it.careers360.com")) {
        		url = urlString + "/colleges/list-of-bca-mca-colleges-in-india" + "?page=" + pageNum;
        	}
        	else if(urlString.equals("https://media.careers360.com")) {
        		url = urlString + "/colleges/list-of-media-journalism-colleges-in-india" + "?page=" + pageNum;
        	}
        	else {
        		url = urlString + "/colleges/ranking" + "?page=" + pageNum;
        	}
        	
        try {
            Document doc = Jsoup.connect(url)
                    .userAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36")
                    .get();
            
            Elements collegeCards = doc.select("div.card_block");
            if (collegeCards.size() == 0) {
                hasData = false;
                System.out.println("No more data found. Ending pagination.");
                break;
            }
            
            System.out.println("Found " + collegeCards.size() + " colleges:");
            
            for(Element card: collegeCards) {
            	String collegeNameSelector = "";
            	String ownership = "";
            	String fees = "";
            	
            	if(url.equals(urlString + "/colleges/list-of-bca-mca-colleges-in-india" + "?page=" + pageNum) 
            			|| url.equals(urlString + "/colleges/list-of-hospitality-tourism-colleges-in-india" + "?page=" + pageNum)
            			|| url.equals(urlString + "/colleges/list-of-media-journalism-colleges-in-india" + "?page=" + pageNum)
            			|| url.equals(urlString + "/colleges/list-of-commerce-colleges-in-india" + "?page=" + pageNum)
            			) {
            		collegeNameSelector = card.select("h3.college_name").text();
            		ownership = card.select("#college-list > div > div > div.facet-tuple-inner-container > div.left_side_tupple.w-100.listing-facet-tupple > div.tupple_top_block > div.tupple_right_block.d-none.d-lg-block > div > div > span:nth-child(1) > p.college-listing-rating").text();
            		fees = card.select("#college-list > div > div > div.facet-tuple-inner-container > div.left_side_tupple.w-100.listing-facet-tupple > div.tupple_bottom_block > div > ul > li").text();
            	} else {
            		collegeNameSelector = card.select("h3.college_name_heading").text();	
                    ownership = card.select("#college-list > div > div > div.facet-tuple-inner-container > div.left_side_tupple > div.tupple_top_block > div.tupple_right_block.d-none.d-lg-block > div > span:nth-child(2) > p.college-rank-rating").text();
                    fees = card.select("li.college-fees-text").text();
            	}
                
                if (!collegeNameSelector.isEmpty()) {
                    String location = collegeNameSelector.substring(collegeNameSelector.lastIndexOf(" ") + 1);
                    
                    // Write to Excel
                    excelExporter.addRow(sheet, rowNum++, collegeNameSelector, fees, ownership, location);
                    
                    // Print 
                    System.out.println("College: " + collegeNameSelector +
                            " || " + fees +
                            " || Ownership: " + ownership +
                            " || Location: " + location);
            	}
            }
            
        } catch (Exception e) {
            // Handle  errors
            System.out.println("No more pages available for " + streamName + " (HTTP " + e.getMessage() + ")");
            hasData = false;
            break;
        } 
//        catch (IOException e) {
//            // Handle other connection errors
//            System.out.println("Connection error for " + streamName + ": " + e.getMessage());
//            hasData = false;
//            break;
//        }
        
        pageNum++;
        try {
			Thread.sleep(1000);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
        
        } 
        
        System.out.println("Completed " + streamName + " - Total rows: " + (rowNum - 1));
        
    	}
    	
    	// Save Excel file
    	excelExporter.saveAndClose("colleges_data.xlsx");
    }
}
