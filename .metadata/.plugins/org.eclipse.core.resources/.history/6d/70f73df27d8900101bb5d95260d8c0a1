package web;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import org.json.JSONArray;
import org.json.JSONObject;

public class ExtractAll {

    public static void main(String[] args) {
        int page = 1;
        int size = 40;
        boolean hasMore = true;
        int totalCount = 0;

        while (hasMore) {
            try {
                String urlStr = "https://digital.dmart.in/api/v3/plp/biscuits---cookies-aesc-biscuitsandcookies"
                        + "?page=" + page
                        + "&size=" + size
                        + "&channel=web"
                        + "&storeId=10151";

                System.out.println("Fetching page " + page + "...");
                String json = getJsonFromUrl(urlStr);

                JSONObject response = new JSONObject(json);
                JSONObject data = response.getJSONObject("data");
                JSONArray products = data.getJSONArray("products");

                if (products.length() == 0) {
                    hasMore = false;
                    System.out.println("No more products. Done!");
                } else {
                    for (int i = 0; i < products.length(); i++) {
                        JSONObject product = products.getJSONObject(i);
                        String name = product.optString("name", "Unknown");
                        String category = product.optString("categoryName", "Unknown");
                        double mrp = product.optDouble("priceMRP", 0.0);
                        double sale = product.optDouble("priceSALE", 0.0);

                        System.out.println((totalCount + 1) + ". " + name);
                        System.out.println("   Category: " + category);
                        System.out.println("   MRP: ₹" + mrp + ", Sale Price: ₹" + sale);
                        System.out.println("------------------------------------------------");
                        totalCount++;
                    }

                    page++; // Go to next page
                }

            } catch (Exception e) {
                System.out.println("Error: " + e.getMessage());
                hasMore = false;
            }
        }

        System.out.println("✅ Total Products Fetched: " + totalCount);
    }

    public static String getJsonFromUrl(String urlString) throws Exception {
        URL url = new URL(urlString);
        HttpURLConnection con = (HttpURLConnection) url.openConnection();
        con.setRequestMethod("GET");
        con.setRequestProperty("Accept", "application/json");

        BufferedReader in = new BufferedReader(new InputStreamReader(con.getInputStream()));
        String inputLine;
        StringBuilder response = new StringBuilder();
        while ((inputLine = in.readLine()) != null) {
            response.append(inputLine);
        }
        in.close();
        con.disconnect();

        return response.toString();
    }
}
