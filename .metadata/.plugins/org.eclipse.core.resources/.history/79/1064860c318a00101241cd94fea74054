package crawlerDesign;


import java.util.ArrayList;
import java.util.List;
import org.jsoup.Connection;
import org.jsoup.Connection.Response;
import org.jsoup.Jsoup;
import org.json.JSONArray;
import org.json.JSONObject;

public class ScrapingLogic {
    
    private static final String BASE_URL = "https://digital.dmart.in/api/v3/plp/biscuits---cookies-aesc-biscuitsandcookies";
    private static final int PAGE_SIZE =40;
    private static final String STORE_ID = "10151";
    
    public List<ProductData> scrapeAllProducts() {
        List<ProductData> allProducts = new ArrayList<>();
        int currPage = 1;
        boolean hasMorePages = true;
        
        while (hasMorePages) {
            System.out.println("Scraping page: " + currPage);
            
            try {
                String jsonResponse = fetchPageData(currPage);
                List<ProductData> pageProducts = parseJson(jsonResponse);
                
                if (pageProducts.isEmpty()) {
                    hasMorePages = false;
                    System.out.println("No more products found. Stopping.");
                } else {
                    allProducts.addAll(pageProducts);
                    System.out.println("Found " + pageProducts.size() + " products on page " + currPage);
                    currPage++;
                    Thread.sleep(1000);
                }
                
            } catch (Exception e) {
                System.out.println("Error scraping page " + currPage +e.getMessage());
                hasMorePages = false;
            }
        }
        
        return allProducts;
    }
    
    private String fetchPageData(int pageNo) throws Exception {
        String url = BASE_URL + "?page=" + pageNo + "&size=" + PAGE_SIZE + 
                    "&channel=web&storeId=" + STORE_ID;
        
        Response res = Jsoup.connect(url)
            .userAgent("Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:142.0) Gecko/20100101 Firefox/142.0")
            .header("Accept", "application/json, text/plain, */*")
            .header("Accept-Language", "en-US,en;q=0.5")
            .ignoreContentType(true)
            .method(Connection.Method.GET).execute();
            
        return res.body();
    }
    
    private List<ProductData> parseJson(String jsonString) {
        List<ProductData> products = new ArrayList<>();
        
        try {
            JSONObject jsonObj = new JSONObject(jsonString);
            
            if (jsonObj.has("products")) {
                JSONArray productsArr = jsonObj.getJSONArray("products");
                
                for (int i = 0; i < productsArr.length(); i++) {
                    JSONObject product = productsArr.getJSONObject(i);
                    
                    String catName = product.optString("categoryName", "N/A");
                    String prodName = product.optString("name", "N/A");
                    
                    JSONArray skus = product.optJSONArray("sKUs");
                    
                        for (int j = 0; j < skus.length(); j++) {
                            JSONObject sku = skus.getJSONObject(j);
   
                            double priceMRP = sku.optDouble("priceMRP", 0.0);

                            
                            ProductData productData = new ProductData(
                                catName, prodName,  priceMRP
                            );
                            products.add(productData);
                        
                    }
                }
            }
        } catch (Exception e) {
            System.out.println("Error parsing JSON: " + e.getMessage());
        }
        
        return products;
    }
    
}
